<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>입출고 및 재고 관리 페이지</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* CSS 코드 (생략) */
    </style>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyC6Mwjy94nr1zf4xPMWU8EqB__9cRZiMcs",
          authDomain: "manage-dee73.firebaseapp.com",
          databaseURL: "https://manage-dee73-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "manage-dee73",
          storageBucket: "manage-dee73.appspot.com",
          messagingSenderId: "519840861970",
          appId: "1:519840861970:web:4e7dfc39cb112e8c8badcb"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const boxSizes = {
            "자이언트플러스": 4,
            "자이언트플러스_R": 4,
            "자이언트플러스_0.5T": 4,
            "빅토리매트": 3,
            "빅토리매트_R": 3,
            "빅토리매트_0.5T": 3
        };

        const matMapping = {
            "정상": "",
            "리퍼브": " R",
            "0.5T": " 0.5T"
        };

        let currentUserName = "";
        let isAdmin = false;

        document.addEventListener("DOMContentLoaded", () => {
            document.getElementById("login-button").addEventListener("click", handleLogin);
            document.getElementById("login-password").addEventListener("keypress", function(e) {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });

            const logoutButton = document.getElementById("logout-button");
            if (logoutButton) {
                logoutButton.addEventListener("click", handleLogout);
            }
        });

        function handleLogin() {
            const name = document.getElementById("login-name").value.trim();
            const password = document.getElementById("login-password").value.trim();
            const autoLogin = document.getElementById("auto-login").checked;

            if (name === "") {
                displayLoginError("이름을 입력해주세요.");
                return;
            }

            if (password === "9998") {
                isAdmin = true;
            } else if (password === "0074") {
                isAdmin = false;
            } else {
                displayLoginError("비밀번호가 올바르지 않습니다.");
                return;
            }

            currentUserName = name;
            document.getElementById("login-section").style.display = "none";
            document.getElementById("main-section").classList.remove("hidden");
            initializeMainSection();
        }

        function initializeMainSection() {
            loadAdminData();
        }

        function loadAdminData() {
            const stockTableBody = document.getElementById("stock-table-body");
            stockTableBody.innerHTML = "";

            firebase.database().ref('stock').once('value')
                .then((snapshot) => {
                    const stockEntries = snapshot.val();
                    const stockMap = {};

                    if (stockEntries) {
                        // 같은 품목과 색상을 가진 항목들을 합산하여 하나의 행으로 저장
                        for (let matFullName in stockEntries) {
                            for (let color in stockEntries[matFullName]) {
                                const qty = stockEntries[matFullName][color];
                                if (!stockMap[matFullName]) stockMap[matFullName] = { "프렌치바닐라": 0, "솔리드그레이": 0, "베이지코튼": 0 };
                                stockMap[matFullName][color] += qty;
                            }
                        }

                        Object.keys(stockMap).forEach(mat => {
                            const colors = stockMap[mat];
                            let row = document.createElement("tr");
                            row.innerHTML = `<td>${mat.replace(/_/g, ' ')}</td>`;
                            let total = 0;
                            ["프렌치바닐라", "솔리드그레이", "베이지코튼"].forEach(color => {
                                const qty = colors[color] || 0;
                                row.innerHTML += `<td>${qty}장</td>`;
                                total += qty;
                            });
                            row.innerHTML += `<td class="total-cell">${total}장</td>`;
                            stockTableBody.appendChild(row);
                        });
                    }
                })
                .catch((error) => {
                    alert("재고 데이터 로드 중 오류 발생: " + error.message);
                });
        }

        function displayLoginError(message) {
            const errorDiv = document.getElementById("login-error");
            errorDiv.textContent = message;
            setTimeout(() => {
                errorDiv.textContent = "";
            }, 3000);
        }

        function handleLogout() {
            currentUserName = "";
            isAdmin = false;
            document.getElementById("main-section").classList.add("hidden");
            document.getElementById("login-section").style.display = "flex";
        }
    </script>
</head>
<body>
    <div class="container">
        <div id="login-section" class="login-section">
            <h2>로그인</h2>
            <div class="login-form">
                <label for="login-name">이름:</label>
                <input type="text" id="login-name" placeholder="이름을 입력하세요">
                <label for="login-password">비밀번호:</label>
                <input type="password" id="login-password" placeholder="비밀번호를 입력하세요">
                <button id="login-button">로그인</button>
                <div id="login-error" class="login-error"></div>
            </div>
        </div>

        <div id="main-section" class="hidden">
            <h1 class="admin-header">재고 관리 페이지</h1>
            <table id="stock-table">
                <thead>
                    <tr>
                        <th rowspan="2">매트 종류</th>
                        <th colspan="3">색상</th>
                        <th rowspan="2">합계</th>
                    </tr>
                    <tr>
                        <th>프렌치바닐라</th>
                        <th>솔리드그레이</th>
                        <th>베이지코튼</th>
                    </tr>
                </thead>
                <tbody id="stock-table-body">
                    <!-- 동적으로 재고가 여기에 추가될 것임 -->
                </tbody>
            </table>
            <button id="logout-button" class="logout-button">로그아웃</button>
        </div>
    </div>
</body>
</html>
