<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>입출고 및 재고 관리 페이지</title>
    <!-- 뷰포트 메타 태그 -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <!-- Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap">
    <!-- SheetJS 라이브러리 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        /* 기본 스타일 설정 */
        body {
            font-family: 'Gowun Dodum', '고운 돋움', sans-serif;
            background-color: #f0f4f8;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            width: 100%;
            max-width: 900px;
            margin: auto;
            background: #ffffff;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            position: relative;
        }
        /* 로그인 섹션 스타일 */
        .login-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background-color: #f0f4f8;
        }
        .login-section h2 {
            margin-bottom: 20px;
            font-size: 28px;
            color: #4a90e2;
        }
        .login-form {
            width: 100%;
            max-width: 400px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .login-form label {
            font-weight: bold;
            font-size: 18px;
            color: #555555;
            display: block;
            margin-bottom: 5px;
        }
        .login-form input[type="text"],
        .login-form input[type="password"] {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: 'Gowun Dodum', '고운 돋움', sans-serif;
            font-size: 16px;
            font-weight: bold;
            transition: border-color 0.3s ease;
            color: #333333;
            background-color: #ffffff;
            width: 100%;
            box-sizing: border-box;
        }
        .login-form input[type="text"]:focus,
        .login-form input[type="password"]:focus {
            border-color: #a8d5e2;
            outline: none;
        }
        .login-form .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .login-form button {
            padding: 12px;
            background-color: #4a90e2;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-family: 'Gowun Dodum', '고운 돋움', sans-serif;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .login-form button:hover {
            background-color: #357ab8;
        }
        .login-error {
            color: red;
            font-size: 14px;
            text-align: center;
        }
        /* 메인 섹션 스타일 */
        .hidden {
            display: none;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .nav-buttons button {
            padding: 15px 25px;
            background-color: #ffc1a1;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            width: 45%;
            box-sizing: border-box;
            font-family: 'Gowun Dodum', '고운 돋움', sans-serif;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .nav-buttons button:hover {
            background-color: #ff8c69;
        }
        .logout-button {
            padding: 10px 20px;
            background-color: #ff5252;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .logout-button:hover {
            background-color: #e53935;
        }
        /* Input Section 스타일 */
        .input-header, .admin-header {
            text-align: center;
            padding: 20px;
            color: #ffffff;
            border-radius: 15px;
            margin-bottom: 25px;
            font-size: 28px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .input-header {
            background-color: #a8d5e2;
        }
        .admin-header {
            background-color: #b3e5d8;
        }
        .form-group {
            display: flex;
            flex-direction: column;
            margin-bottom: 20px;
            padding: 10px;
            background-color: #fff8f0;
            border-radius: 8px;
        }
        label {
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 20px;
            color: #555555;
        }
        select, input[type="text"], input[type="number"] {
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            font-family: 'Gowun Dodum', '고운 돋움', sans-serif;
            width: 100%;
            box-sizing: border-box;
            font-size: 18px;
            font-weight: bold;
            transition: border-color 0.3s ease;
            color: #333333;
            background-color: #ffffff;
        }
        select:focus, input[type="text"]:focus, input[type="number"]:focus {
            border-color: #a8d5e2;
            outline: none;
        }
        textarea {
            width: 100%;
            height: 80px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: none;
            font-family: 'Gowun Dodum', '고운 돋움', sans-serif;
            margin-bottom: 10px;
            font-size: 18px;
            font-weight: bold;
            transition: border-color 0.3s ease;
            color: #333333;
            background-color: #ffffff;
        }
        textarea:focus {
            border-color: #a8d5e2;
            outline: none;
        }
        .buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 25px;
            flex-wrap: wrap;
        }
        button.action-button-in {
            padding: 15px 30px;
            background-color: #a8e6cf;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 22px;
            font-family: 'Gowun Dodum', '고운 돋움', sans-serif;
            width: 45%;
            box-sizing: border-box;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        button.action-button-in:hover {
            background-color: #56c596;
        }
        button.action-button-out {
            padding: 15px 30px;
            background-color: #ffaaa5;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 22px;
            font-family: 'Gowun Dodum', '고운 돋움', sans-serif;
            width: 45%;
            box-sizing: border-box;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        button.action-button-out:hover {
            background-color: #ff6b6b;
        }
        .recent-entries h3 {
            text-align: center;
            background-color: #b3e5d8;
            padding: 18px;
            border-radius: 8px;
            color: white;
            font-size: 22px;
            font-family: 'Gowun Dodum', '고운 돋움', sans-serif;
            font-weight: bold;
            margin-top: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .entry {
            background: #dcedc1;
            margin: 12px 0;
            padding: 15px;
            font-size: 20px;
            border-radius: 8px;
            font-weight: bold;
            word-wrap: break-word;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
        }
        .entry span {
            font-size: 14px;
            color: #555;
            font-weight: normal;
        }
        .total-quantity {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
            margin-top: 10px;
        }
        .total-quantity .category-total {
            font-size: 18px;
            color: #555555;
        }
        .total-quantity .grand-total {
            font-size: 20px;
            font-weight: bold;
            color: #333333;
            margin-top: 10px;
        }
        /* Admin Section 스타일 */
        .admin-header {
            background-color: #b3e5d8;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 16px;
            text-align: center;
            color: #333333;
            font-size: 18px;
            font-weight: bold;
        }
        th {
            background-color: #a8d5e2;
            color: #ffffff;
        }
        .total-cell {
            background-color: #b3e5d8;
            font-weight: bold;
            color: #2e7d32;
        }
        .record-table h3 {
            text-align: center;
            background-color: #b3e5d8;
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 22px;
            font-family: 'Gowun Dodum', '고운 돋움', sans-serif;
            font-weight: bold;
            margin-top: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        .table-container {
            overflow-x: auto;
        }
        .export-buttons {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        .export-buttons button {
            padding: 12px 25px;
            background-color: #a8d5e2;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            width: 45%;
            box-sizing: border-box;
            font-family: 'Gowun Dodum', '고운 돋움', sans-serif;
            font-weight: bold;
            transition: background-color 0.3s ease;
        }
        .export-buttons button:hover {
            background-color: #6fb1d8;
        }
        #clear-stock, #clear-entries {
            padding: 15px 30px;
            background-color: #ffc1a1;
            color: #ffffff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            width: 45%;
            box-sizing: border-box;
            transition: background-color 0.3s ease;
            margin-top: 25px;
        }
        #clear-stock:hover, #clear-entries:hover {
            background-color: #ff8c69;
        }
        /* 로딩 인디케이터 스타일 */
        #loading-indicator {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            font-size: 24px;
            color: #555555;
            font-weight: bold;
            display: none; /* 기본적으로 숨김 */
        }
        /* 모바일 최적화 */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            h1, .login-section h2 {
                font-size: 24px;
                padding: 15px;
            }
            label {
                font-size: 18px;
            }
            select, input[type="text"], input[type="number"], textarea {
                font-size: 16px;
                padding: 12px;
            }
            .nav-buttons button, button.action-button-in, button.action-button-out, button#clear-entries, button#clear-stock, .export-buttons button {
                font-size: 16px;
                padding: 12px 20px;
            }
            .recent-entries h3, .record-table h3 {
                font-size: 20px;
            }
            .entry {
                font-size: 16px;
            }
            th, td {
                font-size: 16px;
                padding: 12px;
            }
            .quantity-group {
                flex-direction: column;
                gap: 5px;
            }
            .quantity-group .form-group {
                width: 100%;
                padding: 5px;
            }
            .total-quantity {
                font-size: 18px;
                gap: 5px;
            }
            .header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            .logout-button {
                align-self: flex-end;
            }
        }
        /* 카테고리 그룹 스타일 */
        .category-group {
            margin-top: 20px;
            padding: 10px;
            background-color: #fff8f0;
            border-radius: 8px;
        }
        .category-group h3 {
            margin-bottom: 10px;
            font-size: 20px;
            color: #555555;
        }
        .category-entry {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .category-entry label {
            flex: 1;
            font-size: 18px;
        }
        .category-entry input[type="number"] {
            width: 80px;
        }
        /* 카테고리별 총 수량 표시 스타일 */
        .category-totals {
            margin-top: 15px;
            padding: 10px;
            background-color: #e0f7fa;
            border-radius: 8px;
        }
        .category-totals .category-total, .category-totals .grand-total {
            font-size: 18px;
            margin-bottom: 5px;
            color: #006064;
        }
    </style>
    <script>
        // Firebase 설정 객체
        const firebaseConfig = {
          apiKey: "AIzaSyC6Mwjy94nr1zf4xPMWU8EqB__9cRZiMcs", // 실제 Firebase 프로젝트의 API 키로 교체해주세요.
          authDomain: "manage-dee73.firebaseapp.com",
          databaseURL: "https://manage-dee73-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "manage-dee73",
          storageBucket: "manage-dee73.firebasestorage.app",
          messagingSenderId: "519840861970",
          appId: "1:519840861970:web:4e7dfc39cb112e8c8badcb"
        };

        // Firebase 초기화
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // 매트 카테고리 상수 정의
        const MAT_CATEGORIES = {
            NORMAL: "정상",
            REFURB: "리퍼브",
            FIVE_T: "05T"
        };

        // 허용된 이름 목록
        const allowedNames = [
            "김수재",
            "용석화",
            "방춘혁",
            "정승훈",
            "문경훈",
            "홍기주",
            "한지석",
            "최동선",
            "이사님",
            "전라지사",
            "관리자"
        ];

        // 매트 종류별 박스당 낱장 수량 매핑
        const boxSizes = {
            "자이언트플러스": 4,
            "자이언트플러스_R": 4,
            "자이언트플러스_05T": 4,
            "빅토리매트": 3,
            "빅토리매트_R": 3,
            "빅토리매트_05T": 3
        };

        // 매트 이름 매핑
        const matMapping = {
            [MAT_CATEGORIES.NORMAL]: "",
            [MAT_CATEGORIES.REFURB]: "_R",
            [MAT_CATEGORIES.FIVE_T]: "_05T"
        };

        // 현재 로그인한 사용자 이름 저장
        let currentUserName = "";
        let isAdmin = false; // 관리자 권한 여부

        // 매트 이름 표준화 함수
        function normalizeMatFullName(matFullName) {
            // 공백 및 특수문자 제거 (Firebase 키에 불가능한 문자 제거)
            return matFullName.replace(/\s+/g, '').replace(/[.#$[\]/]/g,"");
        }

        document.addEventListener("DOMContentLoaded", () => {
            // 초기 화면은 로그인 화면
            const loginSection = document.getElementById("login-section");
            const mainSection = document.getElementById("main-section");

            // 자동 로그인 체크
            const storedLogin = JSON.parse(localStorage.getItem("loginState"));
            if (storedLogin && storedLogin.loggedIn) {
                currentUserName = storedLogin.name;
                isAdmin = storedLogin.isAdmin;
                loginSection.style.display = "none";
                mainSection.classList.remove("hidden");
                initializeMainSection();
            } else {
                loginSection.style.display = "flex";
                mainSection.classList.add("hidden");
            }

            // 로그인 버튼 이벤트 리스너 추가
            document.getElementById("login-button").addEventListener("click", handleLogin);
            document.getElementById("login-password").addEventListener("keypress", function(e) {
                if (e.key === 'Enter') {
                    handleLogin();
                }
            });

            // 로그아웃 버튼 이벤트 리스너 추가
            const logoutButton = document.getElementById("logout-button");
            if (logoutButton) {
                logoutButton.addEventListener("click", handleLogout);
            }
        });

        function handleLogin() {
            const name = document.getElementById("login-name").value.trim();
            const password = document.getElementById("login-password").value.trim();
            const autoLogin = document.getElementById("auto-login").checked;

            if (name === "") {
                displayLoginError("이름을 입력해주세요.");
                return;
            }

            // 이름 허용 여부 확인
            if (!allowedNames.includes(name)) {
                displayLoginError("허용되지 않은 이름입니다.");
                return;
            }

            // 비밀번호 검증
            if (password === "9998") {
                isAdmin = true;
            } else if (password === "0074") {
                isAdmin = false;
            } else {
                displayLoginError("비밀번호가 올바르지 않습니다.");
                return;
            }

            currentUserName = name;

            // 로그인 성공 시 화면 전환
            document.getElementById("login-section").style.display = "none";
            document.getElementById("main-section").classList.remove("hidden");
            initializeMainSection();

            // 자동 로그인 설정
            if (autoLogin) {
                localStorage.setItem("loginState", JSON.stringify({
                    loggedIn: true,
                    name: currentUserName,
                    isAdmin: isAdmin
                }));
            }
        }

        function handleLogout() {
            // 로그인 상태 초기화
            localStorage.removeItem("loginState");
            currentUserName = "";
            isAdmin = false;

            // 메인 섹션 숨기고 로그인 섹션 표시
            document.getElementById("main-section").classList.add("hidden");
            document.getElementById("login-section").style.display = "flex";

            // 초기화
            resetMainSection();
        }

        function displayLoginError(message) {
            const errorDiv = document.getElementById("login-error");
            errorDiv.textContent = message;
            setTimeout(() => {
                errorDiv.textContent = "";
            }, 3000);
        }

        function initializeMainSection() {
            displayRecentEntries();
            loadAdminData();
            resetEntriesDaily(); // 일일 초기화 (재고는 초기화하지 않음)
            calculateTotalQuantity(); // 초기 총 수량 계산
            addEventListeners(); // 이벤트 리스너 추가
        }

        function resetMainSection() {
            // 데이터 초기화 필요 시 여기에 추가
            window.location.reload();
        }

        // 작성 시간을 "MM/DD H:MM" 형식으로 포맷
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const month = date.getMonth() + 1; // 월은 0부터 시작
            const day = date.getDate();
            let hours = date.getHours();
            const minutes = date.getMinutes().toString().padStart(2, '0');
            // 24시간 형식 사용
            return `${month}/${day} ${hours}:${minutes}`;
        }

        // 매트 이름 생성 함수
        function getMatName(category, type) {
            const suffix = matMapping[category] || "";
            const matName = `${type}${suffix}`;
            return normalizeMatFullName(matName);
        }

        async function addEntry(type) {
            const matType = document.getElementById("mat-name").value;
            const color = document.getElementById("mat-color").value;

            // 매트 종류 및 색상 선택 확인
            if (!matType || !color) {
                alert("매트 종류와 색상을 선택해주세요.");
                return;
            }

            // 각 구분별 박스와 장수 입력값 가져오기
            const categories = Object.values(MAT_CATEGORIES);
            const entryData = {};

            let grandTotalQuantity = 0;
            const categoryTotals = {};

            for (let category of categories) {
                const boxInput = parseInt(document.getElementById(`boxes-${category}`).value, 10) || 0;
                const pieceInput = parseInt(document.getElementById(`pieces-${category}`).value, 10) || 0;
                const matFullName = getMatName(category, matType);

                console.log(`Category: ${category}, Mat Type: ${matType}, Mat Full Name: ${matFullName}`);

                const boxSize = boxSizes[matFullName] || 1; // 매트 종류에 따른 박스 크기, 기본값 1
                const quantity = (boxInput * boxSize) + pieceInput;

                entryData[category] = {
                    boxes: boxInput,
                    pieces: pieceInput,
                    quantity: quantity,
                    matFullName: matFullName
                };

                categoryTotals[category] = quantity;
                grandTotalQuantity += quantity;
            }

            // 총 수량이 0보다 커야 함
            if (grandTotalQuantity <= 0) {
                alert("총 수량이 0보다 커야 합니다.");
                return;
            }

            // 입출고 타입 확인
            if (!["입고", "출고"].includes(type)) {
                alert("올바르지 않은 입출고 타입입니다.");
                return;
            }

            // Firebase에 여러 구분에 대한 엔트리 추가
            const entriesRef = firebase.database().ref('entries');
            const updates = {};
            const timestamp = Date.now();

            for (let category of categories) {
                const { boxes, pieces, quantity, matFullName } = entryData[category];
                if (boxes === 0 && pieces === 0) continue; // 입력이 없으면 건너뜀

                const entry = { 
                    name: currentUserName, 
                    category: category, 
                    matName: matFullName, 
                    color, 
                    quantity: quantity, 
                    type, 
                    notes: document.getElementById("notes").value.trim(),
                    timestamp: timestamp,
                    boxes: boxes,
                    pieces: pieces
                };

                const newEntryKey = entriesRef.push().key;
                updates['/entries/' + newEntryKey] = entry;
            }

            try {
                // 엔트리 업데이트
                await firebase.database().ref().update(updates);
                console.log("Entries updated successfully:", updates);

                // 재고 업데이트 트랜잭션
                const stockUpdatePromises = [];
                for (let category of categories) {
                    const { quantity, matFullName, color } = entryData[category];
                    if (quantity === 0) continue;

                    if (!matFullName || !color) {
                        console.error(`matFullName 또는 color가 정의되지 않았습니다. matFullName: ${matFullName}, color: ${color}`);
                        continue;
                    }

                    const stockRef = firebase.database().ref(`/stock/${matFullName}/${color}`);
                    const delta = type === "입고" ? quantity : -quantity;

                    console.log('Updating stock for:', matFullName, color, 'with delta:', delta);

                    const promise = stockRef.transaction((currentQty) => {
                        return (currentQty || 0) + delta;
                    }, (error, committed, snapshot) => {
                        if (error) {
                            console.error('Transaction failed abnormally!', error);
                        } else if (!committed) {
                            console.log('We aborted the transaction.');
                        } else {
                            console.log('Transaction committed successfully!');
                            console.log('New quantity:', snapshot.val());
                        }
                    });
                    stockUpdatePromises.push(promise);
                }

                await Promise.all(stockUpdatePromises);
                console.log("Stock updated successfully via transactions.");

                // UI 업데이트
                resetInputFields();
                alert("데이터가 성공적으로 저장되었습니다.");
            } catch (error) {
                alert("데이터 저장 중 오류 발생: " + error.message);
                console.error("Error updating entries or stock:", error);
            }
        }

        function resetInputFields() {
            const categories = Object.values(MAT_CATEGORIES);
            for (let category of categories) {
                document.getElementById(`boxes-${category}`).value = "";
                document.getElementById(`pieces-${category}`).value = "";
            }
            // 카테고리별 총 수량 초기화
            calculateTotalQuantity();
            document.getElementById("notes").value = "";
        }

        function displayRecentEntries() {
            const recentContainer = document.getElementById("recent-entries");
            recentContainer.innerHTML = "";

            firebase.database().ref('entries').orderByChild('timestamp').limitToLast(10)
                .on('value', (snapshot) => {
                    recentContainer.innerHTML = "";
                    const entries = snapshot.val();
                    if (entries) {
                        const entriesArray = Object.values(entries);
                        // 최신 순으로 내림차순 정렬
                        entriesArray.sort((a, b) => b.timestamp - a.timestamp);
                        let entriesHTML = "";
                        entriesArray.forEach(entry => {
                            const formattedTime = formatTimestamp(entry.timestamp);
                            entriesHTML += `<div class="entry">${entry.name} | ${entry.category} | ${entry.matName} | ${entry.color} | ${entry.quantity}장 (${entry.type}) | ${entry.notes} | <span>${formattedTime}</span></div>`;
                        });
                        recentContainer.innerHTML = entriesHTML;
                    } else {
                        recentContainer.innerHTML = "<div class='entry'>최근 내역이 없습니다.</div>";
                    }
                }, (error) => {
                    alert("실시간 데이터 불러오기 중 오류 발생: " + error.message);
                    console.error("Error fetching recent entries:", error);
                });
        }

        // 일일 초기화 함수
        function resetEntriesDaily() {
            const now = new Date();
            const nextMidnight = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0, 0);
            const msUntilMidnight = nextMidnight - now;

            setTimeout(async () => {
                // 일일 초기화 시 입출고 기록만 초기화 (재고는 초기화하지 않음)
                try {
                    await firebase.database().ref('entries').remove();
                    alert("입출고 내역이 초기화되었습니다.");
                } catch (error) {
                    alert("데이터 초기화 중 오류 발생: " + error.message);
                    console.error("Error resetting entries:", error);
                }
                resetEntriesDaily();
            }, msUntilMidnight);
        }

        function showSection(sectionId) {
            document.getElementById("input-section").classList.add("hidden");
            document.getElementById("admin-section").classList.add("hidden");
            document.getElementById(sectionId).classList.remove("hidden");

            if (sectionId === "admin-section") {
                if (isAdmin) {
                    // 관리자 권한이 있으므로 페이지 접근 가능
                } else {
                    alert("재고 관리 페이지에 접근 권한이 없습니다.");
                    document.getElementById("input-section").classList.remove("hidden");
                    document.getElementById("admin-section").classList.add("hidden");
                }
            }
        }

        function loadAdminData() {
            const stockTableBody = document.getElementById("stock-table-body");
            stockTableBody.innerHTML = "";

            firebase.database().ref('stock').on('value', (snapshot) => {
                const stockEntries = snapshot.val();
                console.log("Stock Entries Loaded:", stockEntries);

                if (stockEntries) {
                    const stockMap = {};

                    // 모든 매트 이름과 색상에 대해 재고를 집계
                    for (let matFullName in stockEntries) {
                        if (!stockMap[matFullName]) {
                            stockMap[matFullName] = { "프렌치바닐라": 0, "솔리드그레이": 0, "베이지코튼": 0 };
                        }
                        for (let color in stockEntries[matFullName]) {
                            const qty = parseInt(stockEntries[matFullName][color], 10) || 0;
                            stockMap[matFullName][color] = qty;
                        }
                    }

                    const matTypes = Object.keys(stockMap);
                    let rowsHTML = "";

                    matTypes.forEach(mat => {
                        const colors = stockMap[mat];
                        let total = 0;
                        let row = `<tr><td>${mat}</td>`;
                        ["프렌치바닐라", "솔리드그레이", "베이지코튼"].forEach(color => {
                            const qty = colors[color] || 0;
                            row += `<td>${qty}장</td>`;
                            total += qty;
                        });
                        row += `<td class="total-cell">${total}장</td></tr>`;
                        rowsHTML += row;
                    });

                    stockTableBody.innerHTML = rowsHTML;
                } else {
                    // 재고 데이터가 없을 때 기본 값 표시
                    const matTypes = ["자이언트플러스", "빅토리매트"];
                    let rowsHTML = "";
                    matTypes.forEach(mat => {
                        rowsHTML += `<tr><td>${mat}</td><td>0장</td><td>0장</td><td>0장</td><td class="total-cell">0장</td></tr>`;
                    });
                    stockTableBody.innerHTML = rowsHTML;
                }
            }, (error) => {
                alert("재고 데이터 로드 중 오류 발생: " + error.message);
                console.error("Error loading stock data:", error);
            });

            // 입출고 기록 테이블 로드
            loadEntryRecords();
        }

        function loadEntryRecords() {
            const recordsTableBody = document.getElementById("admin-table-body");
            recordsTableBody.innerHTML = "";

            firebase.database().ref('entries')
                .on('value', (snapshot) => {
                    recordsTableBody.innerHTML = "";
                    const adminEntries = snapshot.val();
                    if (adminEntries) {
                        const entriesArray = Object.values(adminEntries);
                        // 오래된 순으로 오름차순 정렬
                        entriesArray.sort((a, b) => a.timestamp - b.timestamp);
                        let recordsHTML = "";
                        entriesArray.forEach(entry => {
                            const formattedTime = formatTimestamp(entry.timestamp);
                            recordsHTML += `
                                <tr>
                                    <td>${entry.name}</td>
                                    <td>${entry.category}</td>
                                    <td>${entry.matName}</td>
                                    <td>${entry.color}</td>
                                    <td>${entry.quantity}장</td>
                                    <td>${entry.type}</td>
                                    <td>${entry.notes}</td>
                                    <td>${formattedTime}</td>
                                </tr>
                            `;
                        });
                        recordsTableBody.innerHTML = recordsHTML;
                    } else {
                        recordsTableBody.innerHTML = "<tr><td colspan='8'>입출고 기록이 없습니다.</td></tr>";
                    }
                }, (error) => {
                    alert("입출고 기록 로드 중 오류 발생: " + error.message);
                    console.error("Error loading entry records:", error);
                });
        }

        // 초기화 버튼을 두 개로 분리
        async function clearEntries() {
            if (confirm("입출고 기록을 초기화하시겠습니까?")) {
                // 로딩 인디케이터 표시
                document.getElementById("loading-indicator").style.display = "flex";
                try {
                    // Realtime Database의 'entries' 노드 삭제
                    await firebase.database().ref('entries').remove();
                    alert("입출고 기록이 초기화되었습니다.");
                } catch (error) {
                    alert("입출고 기록 초기화 중 오류 발생: " + error.message);
                    console.error("Error clearing entries:", error);
                } finally {
                    // 로딩 인디케이터 숨기기
                    document.getElementById("loading-indicator").style.display = "none";
                }
            }
        }

        async function clearStock() {
            if (confirm("재고 내역을 초기화하시겠습니까?")) {
                // 로딩 인디케이터 표시
                document.getElementById("loading-indicator").style.display = "flex";
                try {
                    // Realtime Database의 'stock' 노드 삭제
                    await firebase.database().ref('stock').remove();
                    alert("재고 내역이 초기화되었습니다.");
                } catch (error) {
                    alert("재고 내역 초기화 중 오류 발생: " + error.message);
                    console.error("Error clearing stock:", error);
                } finally {
                    // 로딩 인디케이터 숨기기
                    document.getElementById("loading-indicator").style.display = "none";
                }
            }
        }

        // 엑셀 저장 함수: 재고 내역
        function exportStock() {
            const table = document.getElementById('stock-table');
            const workbook = XLSX.utils.table_to_book(table, {sheet:"재고내역"});

            // 워크시트 가져오기
            const worksheet = workbook.Sheets["재고내역"];

            // 헤더 스타일링: 첫 번째 행을 굵게(Bold)
            const range = XLSX.utils.decode_range(worksheet['!ref']);
            for(let C = range.s.c; C <= range.e.c; ++C) {
                const cell_address = {c: C, r: 0};
                const cell_ref = XLSX.utils.encode_cell(cell_address);
                if(!worksheet[cell_ref]) continue;
                if(!worksheet[cell_ref].s) worksheet[cell_ref].s = {};
                worksheet[cell_ref].s.font = { bold: true };
            }

            // 열 너비 설정
            worksheet['!cols'] = [
                { wch: 20 }, // 매트 종류
                { wch: 20 }, // 프렌치바닐라
                { wch: 20 }, // 솔리드그레이
                { wch: 20 }, // 베이지코튼
                { wch: 10 }  // 합계
            ];

            // 수량과 합계에서 '장' 제거
            for(let R = 1; R <= range.e.r; ++R) { // 첫 번째 행은 헤더이므로 1부터 시작
                // 프렌치바닐라 컬럼 (2번째 컬럼, 인덱스 1)
                const cellRefFrVanilla = XLSX.utils.encode_cell({c: 1, r: R});
                if(worksheet[cellRefFrVanilla] && typeof worksheet[cellRefFrVanilla].v === 'string') {
                    const num = parseInt(worksheet[cellRefFrVanilla].v.replace('장', '').trim(), 10);
                    if(!isNaN(num)) {
                        worksheet[cellRefFrVanilla].v = num;
                        worksheet[cellRefFrVanilla].t = 'n'; // 숫자 타입으로 설정
                    }
                }

                // 솔리드그레이 컬럼 (3번째 컬럼, 인덱스 2)
                const cellRefSolidGray = XLSX.utils.encode_cell({c: 2, r: R});
                if(worksheet[cellRefSolidGray] && typeof worksheet[cellRefSolidGray].v === 'string') {
                    const num = parseInt(worksheet[cellRefSolidGray].v.replace('장', '').trim(), 10);
                    if(!isNaN(num)) {
                        worksheet[cellRefSolidGray].v = num;
                        worksheet[cellRefSolidGray].t = 'n'; // 숫자 타입으로 설정
                    }
                }

                // 베이지코튼 컬럼 (4번째 컬럼, 인덱스 3)
                const cellRefBeigeCotton = XLSX.utils.encode_cell({c: 3, r: R});
                if(worksheet[cellRefBeigeCotton] && typeof worksheet[cellRefBeigeCotton].v === 'string') {
                    const num = parseInt(worksheet[cellRefBeigeCotton].v.replace('장', '').trim(), 10);
                    if(!isNaN(num)) {
                        worksheet[cellRefBeigeCotton].v = num;
                        worksheet[cellRefBeigeCotton].t = 'n'; // 숫자 타입으로 설정
                    }
                }

                // 합계 컬럼 (5번째 컬럼, 인덱스 4)
                const cellRefTotal = XLSX.utils.encode_cell({c: 4, r: R});
                if(worksheet[cellRefTotal] && typeof worksheet[cellRefTotal].v === 'string') {
                    const num = parseInt(worksheet[cellRefTotal].v.replace('장', '').trim(), 10);
                    if(!isNaN(num)) {
                        worksheet[cellRefTotal].v = num;
                        worksheet[cellRefTotal].t = 'n'; // 숫자 타입으로 설정
                    }
                }
            }

            // 워크북에 수정된 워크시트 다시 설정
            workbook.Sheets["재고내역"] = worksheet;

            // 워크북 저장
            const date = new Date();
            const formattedDate = `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}`;
            const filename = `${formattedDate}_재고내역.xlsx`;
            XLSX.writeFile(workbook, filename);
        }

        // 엑셀 저장 함수: 입출고 기록
        function exportRecords() {
            // 먼저 데이터를 새 배열로 복사하고, 오름차순으로 정렬
            firebase.database().ref('entries').once('value')
                .then((snapshot) => {
                    const adminEntries = snapshot.val();
                    let entriesArray = [];
                    if (adminEntries) {
                        entriesArray = Object.values(adminEntries);
                        // 오래된 순으로 오름차순 정렬
                        entriesArray.sort((a, b) => a.timestamp - b.timestamp);
                    }

                    // 임시 테이블 생성
                    const tempTable = document.createElement("table");
                    const thead = document.createElement("thead");
                    thead.innerHTML = `
                        <tr>
                            <th>이름</th>
                            <th>구분</th>
                            <th>매트 종류</th>
                            <th>색상</th>
                            <th>수량</th>
                            <th>입출고</th>
                            <th>비고</th>
                            <th>작성시간</th>
                        </tr>
                    `;
                    tempTable.appendChild(thead);

                    const tbody = document.createElement("tbody");
                    entriesArray.forEach(entry => {
                        const formattedTime = formatTimestamp(entry.timestamp);
                        tbody.innerHTML += `
                            <tr>
                                <td>${entry.name}</td>
                                <td>${entry.category}</td>
                                <td>${entry.matName}</td>
                                <td>${entry.color}</td>
                                <td>${entry.quantity}장</td>
                                <td>${entry.type}</td>
                                <td>${entry.notes}</td>
                                <td>${formattedTime}</td>
                            </tr>
                        `;
                    });
                    tempTable.appendChild(tbody);

                    // SheetJS를 사용하여 엑셀로 변환
                    const workbook = XLSX.utils.table_to_book(tempTable, {sheet:"입출고기록"});

                    // 워크시트 가져오기
                    const worksheet = workbook.Sheets["입출고기록"];

                    // 헤더 스타일링: 첫 번째 행을 굵게(Bold)
                    const range = XLSX.utils.decode_range(worksheet['!ref']);
                    for(let C = range.s.c; C <= range.e.c; ++C) {
                        const cell_address = {c: C, r: 0};
                        const cell_ref = XLSX.utils.encode_cell(cell_address);
                        if(!worksheet[cell_ref]) continue;
                        if(!worksheet[cell_ref].s) worksheet[cell_ref].s = {};
                        worksheet[cell_ref].s.font = { bold: true };
                    }

                    // 열 너비 설정
                    worksheet['!cols'] = [
                        { wch: 15 }, // 이름
                        { wch: 15 }, // 구분
                        { wch: 20 }, // 매트 종류
                        { wch: 15 }, // 색상
                        { wch: 10 }, // 수량
                        { wch: 10 }, // 입출고
                        { wch: 25 }, // 비고
                        { wch: 15 }  // 작성시간
                    ];

                    // 수량에서 '장' 제거
                    for(let R = 1; R <= range.e.r; ++R) { // 첫 번째 행은 헤더이므로 1부터 시작
                        // 수량 컬럼 (5번째 컬럼, 인덱스 4)
                        const cellRefQty = XLSX.utils.encode_cell({c: 4, r: R});
                        if(worksheet[cellRefQty] && typeof worksheet[cellRefQty].v === 'string') {
                            const num = parseInt(worksheet[cellRefQty].v.replace('장', '').trim(), 10);
                            if(!isNaN(num)) {
                                worksheet[cellRefQty].v = num;
                                worksheet[cellRefQty].t = 'n'; // 숫자 타입으로 설정
                            }
                        }
                    }

                    // 워크북에 수정된 워크시트 다시 설정
                    workbook.Sheets["입출고기록"] = worksheet;

                    // 워크북 저장
                    const date = new Date();
                    const formattedDate = `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}`;
                    const filename = `${formattedDate}_입출고기록.xlsx`;
                    XLSX.writeFile(workbook, filename);
                })
                .catch((error) => {
                    alert("입출고 기록 내보내기 중 오류 발생: " + error.message);
                    console.error("Error exporting records:", error);
                });
        }

        // 총 수량 계산 함수
        function calculateTotalQuantity() {
            const categories = Object.values(MAT_CATEGORIES);
            let grandTotalQuantity = 0;
            const categoryTotals = {};

            const matType = document.getElementById("mat-name").value;
            if (!matType) {
                // 매트 종류가 선택되지 않았을 경우 수량을 계산하지 않음
                const categoryTotalDiv = document.getElementById("category-totals");
                categoryTotalDiv.innerHTML = "";
                categories.forEach(category => {
                    categoryTotalDiv.innerHTML += `<div class="category-total">${category}: 0장</div>`;
                });
                categoryTotalDiv.innerHTML += `<div class="grand-total">총 수량: 0장</div>`;
                return;
            }

            for (let category of categories) {
                const boxes = parseInt(document.getElementById(`boxes-${category}`).value, 10) || 0;
                const pieces = parseInt(document.getElementById(`pieces-${category}`).value, 10) || 0;
                const matFullName = getMatName(category, matType);
                const boxSize = boxSizes[matFullName] || 1; // 매트 종류에 따른 박스 크기, 기본값 1
                const quantity = (boxes * boxSize) + pieces;
                categoryTotals[category] = quantity;
                grandTotalQuantity += quantity;
            }

            // UI 업데이트
            const categoryTotalDiv = document.getElementById("category-totals");

            // 기존 내용 제거
            categoryTotalDiv.innerHTML = "";

            // 새로운 카테고리별 총 수량 표시
            for (let category of categories) {
                categoryTotalDiv.innerHTML += `<div class="category-total">${category}: ${categoryTotals[category]}장</div>`;
            }
            categoryTotalDiv.innerHTML += `<div class="grand-total">총 수량: ${grandTotalQuantity}장</div>`;
        }

        // 이벤트 리스너 추가 함수
        function addEventListeners() {
            const categories = Object.values(MAT_CATEGORIES);
            for (let category of categories) {
                document.getElementById(`boxes-${category}`).addEventListener("input", calculateTotalQuantity);
                document.getElementById(`pieces-${category}`).addEventListener("input", calculateTotalQuantity);
            }
            document.getElementById("mat-name").addEventListener("change", calculateTotalQuantity);
            document.getElementById("mat-color").addEventListener("change", calculateTotalQuantity);
        }

        // 재고 동기화 함수
        async function synchronizeStock() {
            if (!isAdmin) {
                alert("재고 동기화는 관리자만 가능합니다.");
                return;
            }

            if (!confirm("입출고 기록을 바탕으로 재고를 동기화하시겠습니까? 이 작업은 기존 재고 데이터를 덮어씁니다.")) {
                return;
            }

            // 로딩 인디케이터 표시
            document.getElementById("loading-indicator").style.display = "flex";

            try {
                const snapshot = await firebase.database().ref('entries').once('value');
                const entries = snapshot.val();
                if (!entries) {
                    alert("입출고 기록이 없습니다. 동기화를 진행할 수 없습니다.");
                    throw new Error("No entries to synchronize.");
                }

                const stockMap = {};

                // 모든 입출고 기록을 순회하여 재고 계산
                Object.values(entries).forEach(entry => {
                    let { matName, color, quantity, type } = entry;

                    if (!stockMap[matName]) {
                        stockMap[matName] = {};
                    }
                    if (!stockMap[matName][color]) {
                        stockMap[matName][color] = 0;
                    }

                    if (type === "입고") {
                        stockMap[matName][color] += quantity;
                    } else if (type === "출고") {
                        stockMap[matName][color] -= quantity;
                    }
                });

                // Firebase의 stock 노드를 업데이트
                const updates = {};
                for (const mat in stockMap) {
                    for (const color in stockMap[mat]) {
                        updates[`/stock/${mat}/${color}`] = stockMap[mat][color];
                    }
                }

                await firebase.database().ref().update(updates);
                alert("재고가 성공적으로 동기화되었습니다.");
                loadAdminData();
            } catch (error) {
                alert("재고 동기화 중 오류 발생: " + error.message);
                console.error("Error synchronizing stock:", error);
            } finally {
                // 로딩 인디케이터 숨기기
                document.getElementById("loading-indicator").style.display = "none";
            }
        }

        // 입력 필드 클릭 시 기본 값 제거
        function clearValue(element) {
            element.value = "";
        }
    </script>
</head>
<body>
    <div class="container">
        <!-- 로그인 섹션 -->
        <div id="login-section" class="login-section">
            <h2>로그인</h2>
            <div class="login-form">
                <div>
                    <label for="login-name">이름:</label>
                    <input type="text" id="login-name" placeholder="이름을 입력하세요">
                </div>
                <div>
                    <label for="login-password">비밀번호:</label>
                    <input type="password" id="login-password" placeholder="비밀번호를 입력하세요">
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="auto-login">
                    <label for="auto-login">자동 로그인</label>
                </div>
                <button id="login-button">로그인</button>
                <div id="login-error" class="login-error"></div>
            </div>
        </div>

        <!-- 메인 섹션 (로그인 후 표시) -->
        <div id="main-section" class="hidden">
            <!-- 헤더 섹션: 네비게이션 버튼과 로그아웃 버튼 -->
            <div class="header">
                <div class="nav-buttons">
                    <button onclick="showSection('input-section')">토리매트 입/출고</button>
                    <button onclick="showSection('admin-section')">재고 관리 페이지</button>
                </div>
                <button id="logout-button" class="logout-button">로그아웃</button>
            </div>

            <!-- Input Section -->
            <div id="input-section">
                <h1 class="input-header">토리매트 입/출고</h1>

                <div class="form-group">
                    <label for="mat-name">매트 종류:</label>
                    <select id="mat-name">
                        <option value="" disabled selected>매트 종류를 선택하세요</option>
                        <option>자이언트플러스</option>
                        <option>빅토리매트</option>
                    </select>

                    <label for="mat-color">색상:</label>
                    <select id="mat-color">
                        <option value="" disabled selected>색상을 선택하세요</option>
                        <option>프렌치바닐라</option>
                        <option>솔리드그레이</option>
                        <option>베이지코튼</option>
                    </select>
                </div>

                <!-- 구분별 박스와 장수 입력 -->
                <div class="category-group" id="category-group">
                    <h3>구분별 입력</h3>
                    <!-- 각 구분에 대한 입력 필드 -->
                    <div class="category-entry">
                        <label for="boxes-정상">정상:</label>
                        <input type="number" id="boxes-정상" min="0" placeholder="박스" onfocus="clearValue(this)">
                        <input type="number" id="pieces-정상" min="0" placeholder="낱장" onfocus="clearValue(this)">
                    </div>
                    <div class="category-entry">
                        <label for="boxes-리퍼브">리퍼브:</label>
                        <input type="number" id="boxes-리퍼브" min="0" placeholder="박스" onfocus="clearValue(this)">
                        <input type="number" id="pieces-리퍼브" min="0" placeholder="낱장" onfocus="clearValue(this)">
                    </div>
                    <div class="category-entry">
                        <label for="boxes-05T">05T:</label>
                        <input type="number" id="boxes-05T" min="0" placeholder="박스" onfocus="clearValue(this)">
                        <input type="number" id="pieces-05T" min="0" placeholder="낱장" onfocus="clearValue(this)">
                    </div>
                </div>

                <!-- 카테고리별 총 수량 및 전체 총 수량 표시 -->
                <div id="category-totals" class="category-totals">
                    <!-- JavaScript에 의해 동적으로 추가됩니다 -->
                </div>

                <div class="form-group">
                    <label for="notes">비고:</label>
                    <textarea id="notes" placeholder="비고 내용을 입력하세요."></textarea>
                </div>

                <div class="buttons">
                    <button class="action-button-in" onclick="addEntry('입고')">입고</button>
                    <button class="action-button-out" onclick="addEntry('출고')">출고</button>
                </div>

                <div class="recent-entries">
                    <h3>최근 입/출고 내역</h3>
                    <div id="recent-entries"></div>
                </div>
            </div>

            <!-- Admin Section -->
            <div id="admin-section" class="hidden">
                <h1 class="admin-header">재고 관리 페이지</h1>

                <table id="stock-table">
                    <thead>
                        <tr>
                            <th rowspan="2">매트 종류</th>
                            <th colspan="3">색상</th>
                            <th rowspan="2">합계</th>
                        </tr>
                        <tr>
                            <th>프렌치바닐라</th>
                            <th>솔리드그레이</th>
                            <th>베이지코튼</th>
                        </tr>
                    </thead>
                    <tbody id="stock-table-body">
                        <!-- 동적으로 재고가 여기에 추가될 것임 -->
                    </tbody>
                </table>

                <!-- 엑셀 저장 버튼 추가 -->
                <div class="export-buttons">
                    <button onclick="exportStock()">재고 내역 엑셀 저장</button>
                    <button onclick="exportRecords()">입출고 기록 엑셀 저장</button>
                </div>

                <!-- 재고 동기화 버튼 추가 -->
                <div class="export-buttons">
                    <button onclick="synchronizeStock()">재고 동기화</button>
                </div>

                <h3 class="record-table">입출고 기록 내역</h3>
                <div class="table-container">
                    <table id="records-table">
                        <thead>
                            <tr>
                                <th>이름</th>
                                <th>구분</th>
                                <th>매트 종류</th>
                                <th>색상</th>
                                <th>수량</th>
                                <th>입출고</th>
                                <th>비고</th>
                                <th>작성시간</th>
                            </tr>
                        </thead>
                        <tbody id="admin-table-body">
                            <!-- 데이터가 여기에 동적으로 추가될 것임 -->
                        </tbody>
                    </table>
                </div>

                <!-- 초기화 버튼 두 개로 분리 -->
                <div class="export-buttons">
                    <button id="clear-stock" onclick="clearStock()">재고 내역 초기화</button>
                    <button id="clear-entries" onclick="clearEntries()">입출고 기록 초기화</button>
                </div>
            </div>
        </div>

        <!-- 로딩 인디케이터 -->
        <div id="loading-indicator">
            <p>처리 중입니다...</p>
        </div>
    </div>
</body>
</html>
